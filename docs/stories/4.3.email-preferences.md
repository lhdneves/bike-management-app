# Story 4.3 - Email Preferences & Management

## Status

üìã **READY FOR PLANNING**

**Epic**: [Epic 7 - Email Management System](./epic-7-email-management.md)  
**Priority**: MEDIUM  
**Story Points**: 3  
**Sprint**: 2 or 3  
**Dependencies**: [Story 4.1](./4.1.email-infrastructure.md) (Email Infrastructure)

## ‚öôÔ∏è Story Overview

**Como** usu√°rio do sistema  
**Eu quero** gerenciar minhas prefer√™ncias de email  
**Para que** eu tenha controle sobre quais emails recebo e com que frequ√™ncia

## üéØ Business Value

- **User Control**: D√° autonomia ao usu√°rio sobre comunica√ß√µes
- **Compliance**: Atende requisitos LGPD/GDPR de opt-out
- **Retention**: Usu√°rios com controle s√£o menos propensos a abandonar
- **Trust**: Demonstra respeito pela privacidade do usu√°rio

## üìã Acceptance Criteria

### AC1: Email Preferences API
- [ ] GET `/api/user/email-preferences` endpoint
- [ ] PUT `/api/user/email-preferences` endpoint
- [ ] Validation de prefer√™ncias v√°lidas
- [ ] Authentication required para todos endpoints
- [ ] Error handling e status codes apropriados

### AC2: Email Preferences Data Model
- [ ] Database structure para user preferences
- [ ] Default values para novos usu√°rios
- [ ] Migration script para usu√°rios existentes
- [ ] Indexing para performance
- [ ] Audit trail de mudan√ßas

### AC3: Frontend Settings Interface
- [ ] P√°gina de configura√ß√µes de email (`/settings/notifications`)
- [ ] Toggle switches para diferentes tipos de email
- [ ] Frequency selection (immediate, daily, weekly, disabled)
- [ ] Save/Cancel functionality
- [ ] Real-time validation e feedback

### AC4: Unsubscribe Functionality
- [ ] Unsubscribe links em todos os emails
- [ ] One-click unsubscribe page
- [ ] Granular unsubscribe (por tipo de email)
- [ ] Confirmation page ap√≥s unsubscribe
- [ ] Re-subscribe option dispon√≠vel

### AC5: Preference Enforcement
- [ ] Check preferences antes de enviar qualquer email
- [ ] Respect frequency settings
- [ ] Global unsubscribe handling
- [ ] Logging de emails n√£o enviados devido a preferences
- [ ] Graceful degradation se preferences n√£o carregarem

## üîß Technical Implementation

### Database Schema
```sql
-- Enhanced user_email_preferences table
CREATE TABLE user_email_preferences (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) UNIQUE,
  
  -- Email types
  maintenance_reminders BOOLEAN DEFAULT true,
  system_notifications BOOLEAN DEFAULT true,
  marketing_emails BOOLEAN DEFAULT false,
  security_alerts BOOLEAN DEFAULT true,
  
  -- Frequency settings
  reminder_frequency VARCHAR(20) DEFAULT 'immediate', -- 'immediate', 'daily', 'weekly', 'disabled'
  digest_frequency VARCHAR(20) DEFAULT 'weekly', -- 'daily', 'weekly', 'monthly', 'disabled'
  
  -- Global settings
  global_unsubscribe BOOLEAN DEFAULT false,
  unsubscribed_at TIMESTAMPTZ,
  unsubscribe_token VARCHAR(255) UNIQUE,
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_email_preferences_user_id ON user_email_preferences(user_id);
CREATE INDEX idx_user_email_preferences_unsubscribe_token ON user_email_preferences(unsubscribe_token);
```

### API Endpoints

#### GET /api/user/email-preferences
```typescript
interface EmailPreferencesResponse {
  success: boolean;
  data: {
    maintenance_reminders: boolean;
    system_notifications: boolean;
    marketing_emails: boolean;
    security_alerts: boolean;
    reminder_frequency: 'immediate' | 'daily' | 'weekly' | 'disabled';
    digest_frequency: 'daily' | 'weekly' | 'monthly' | 'disabled';
    global_unsubscribe: boolean;
  };
}
```

#### PUT /api/user/email-preferences
```typescript
interface UpdateEmailPreferencesRequest {
  maintenance_reminders?: boolean;
  system_notifications?: boolean;
  marketing_emails?: boolean;
  security_alerts?: boolean;
  reminder_frequency?: 'immediate' | 'daily' | 'weekly' | 'disabled';
  digest_frequency?: 'daily' | 'weekly' | 'monthly' | 'disabled';
}

interface UpdateEmailPreferencesResponse {
  success: boolean;
  message: string;
  data: EmailPreferences;
}
```

### Email Preference Service
```typescript
// backend/src/services/emailPreferenceService.ts
export class EmailPreferenceService {
  async getUserPreferences(userId: string): Promise<EmailPreferences | null> {
    return await prisma.userEmailPreferences.findUnique({
      where: { userId },
    });
  }

  async updateUserPreferences(userId: string, preferences: Partial<EmailPreferences>): Promise<EmailPreferences> {
    return await prisma.userEmailPreferences.upsert({
      where: { userId },
      update: {
        ...preferences,
        updatedAt: new Date(),
      },
      create: {
        userId,
        ...preferences,
      },
    });
  }

  async canSendEmail(userId: string, emailType: EmailType): Promise<boolean> {
    const preferences = await this.getUserPreferences(userId);
    
    if (!preferences || preferences.global_unsubscribe) {
      return false;
    }

    switch (emailType) {
      case 'maintenance_reminder':
        return preferences.maintenance_reminders && preferences.reminder_frequency !== 'disabled';
      case 'system_notification':
        return preferences.system_notifications;
      case 'security_alert':
        return preferences.security_alerts; // Always respect security alerts
      default:
        return false;
    }
  }

  async generateUnsubscribeToken(userId: string): Promise<string> {
    const token = crypto.randomBytes(32).toString('hex');
    
    await prisma.userEmailPreferences.upsert({
      where: { userId },
      update: { unsubscribeToken: token },
      create: { userId, unsubscribeToken: token },
    });

    return token;
  }
}
```

### Frontend Settings Component
```typescript
// frontend/src/components/settings/EmailPreferences.tsx
import { useState, useEffect } from 'react';

interface EmailPreferences {
  maintenance_reminders: boolean;
  system_notifications: boolean;
  marketing_emails: boolean;
  security_alerts: boolean;
  reminder_frequency: string;
  digest_frequency: string;
}

export default function EmailPreferences() {
  const [preferences, setPreferences] = useState<EmailPreferences | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);

  useEffect(() => {
    loadPreferences();
  }, []);

  const loadPreferences = async () => {
    try {
      const response = await fetch('/api/user/email-preferences', {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
      });
      const data = await response.json();
      if (data.success) {
        setPreferences(data.data);
      }
    } catch (error) {
      console.error('Failed to load preferences:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const savePreferences = async () => {
    if (!preferences) return;

    setIsSaving(true);
    try {
      const response = await fetch('/api/user/email-preferences', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
        body: JSON.stringify(preferences),
      });

      const data = await response.json();
      if (data.success) {
        // Show success message
        console.log('Preferences saved successfully');
      }
    } catch (error) {
      console.error('Failed to save preferences:', error);
    } finally {
      setIsSaving(false);
    }
  };

  if (isLoading) {
    return <div>Loading preferences...</div>;
  }

  return (
    <div className="max-w-2xl mx-auto p-6">
      <h2 className="text-2xl font-bold mb-6">Email Preferences</h2>
      
      <div className="space-y-6">
        <div className="bg-white shadow rounded-lg p-6">
          <h3 className="text-lg font-medium mb-4">Notification Types</h3>
          
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <label className="text-sm font-medium text-gray-700">
                  Maintenance Reminders
                </label>
                <p className="text-sm text-gray-500">
                  Get reminded about upcoming scheduled maintenance
                </p>
              </div>
              <input
                type="checkbox"
                checked={preferences?.maintenance_reminders}
                onChange={(e) => setPreferences(prev => prev ? {...prev, maintenance_reminders: e.target.checked} : null)}
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
            </div>

            <div className="flex items-center justify-between">
              <div>
                <label className="text-sm font-medium text-gray-700">
                  System Notifications
                </label>
                <p className="text-sm text-gray-500">
                  Important updates and system messages
                </p>
              </div>
              <input
                type="checkbox"
                checked={preferences?.system_notifications}
                onChange={(e) => setPreferences(prev => prev ? {...prev, system_notifications: e.target.checked} : null)}
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
            </div>

            <div className="flex items-center justify-between">
              <div>
                <label className="text-sm font-medium text-gray-700">
                  Security Alerts
                </label>
                <p className="text-sm text-gray-500">
                  Critical security notifications (recommended)
                </p>
              </div>
              <input
                type="checkbox"
                checked={preferences?.security_alerts}
                onChange={(e) => setPreferences(prev => prev ? {...prev, security_alerts: e.target.checked} : null)}
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
            </div>
          </div>
        </div>

        <div className="bg-white shadow rounded-lg p-6">
          <h3 className="text-lg font-medium mb-4">Frequency Settings</h3>
          
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Reminder Frequency
              </label>
              <select
                value={preferences?.reminder_frequency}
                onChange={(e) => setPreferences(prev => prev ? {...prev, reminder_frequency: e.target.value} : null)}
                className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
              >
                <option value="immediate">Immediate</option>
                <option value="daily">Daily Digest</option>
                <option value="weekly">Weekly Digest</option>
                <option value="disabled">Disabled</option>
              </select>
            </div>
          </div>
        </div>

        <div className="flex justify-end space-x-3">
          <button
            onClick={loadPreferences}
            className="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
          >
            Reset
          </button>
          <button
            onClick={savePreferences}
            disabled={isSaving}
            className="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50"
          >
            {isSaving ? 'Saving...' : 'Save Preferences'}
          </button>
        </div>
      </div>
    </div>
  );
}
```

## üß™ Testing Strategy

### Unit Tests
- [ ] EmailPreferenceService methods
- [ ] API endpoint validation
- [ ] Preference enforcement logic
- [ ] Unsubscribe token generation

### Integration Tests
- [ ] Full preference update flow
- [ ] Email sending with preference checks
- [ ] Unsubscribe flow end-to-end
- [ ] Database operations

### E2E Tests
- [ ] User updates preferences via UI
- [ ] Preferences are respected in email sending
- [ ] Unsubscribe link works correctly
- [ ] Re-subscribe functionality works

## üìä Success Metrics

### Technical KPIs
- [ ] 100% preference enforcement accuracy
- [ ] < 500ms preference API response time
- [ ] Zero preference-related email failures
- [ ] 99.9% unsubscribe link reliability

### Business KPIs
- [ ] < 5% overall unsubscribe rate
- [ ] 80%+ users engage with preference settings
- [ ] 95% user satisfaction with email control
- [ ] Zero compliance violations

## ‚öôÔ∏è Environment Variables

```bash
# Email Preference Settings
DEFAULT_MAINTENANCE_REMINDERS=true
DEFAULT_SYSTEM_NOTIFICATIONS=true
DEFAULT_MARKETING_EMAILS=false
DEFAULT_SECURITY_ALERTS=true

# Unsubscribe Settings
UNSUBSCRIBE_BASE_URL=${FRONTEND_URL}/unsubscribe
```

## üîç Risk Assessment

### Technical Risks
- **Low**: Database migration complexity
- **Low**: Frontend state management
- **Medium**: Preference enforcement edge cases

### Mitigation
- Comprehensive migration testing
- Simple, clear state management patterns
- Extensive edge case testing
- Default safe values (opt-out rather than opt-in)

## üìã Definition of Done

### Functional Requirements
- [ ] All Acceptance Criteria completed
- [ ] User can manage email preferences
- [ ] Preferences are enforced in email sending
- [ ] Unsubscribe functionality works
- [ ] UI is intuitive and accessible

### Quality Assurance
- [ ] 95%+ test coverage
- [ ] Accessibility testing (WCAG 2.1 AA)
- [ ] Cross-browser compatibility
- [ ] Mobile responsiveness
- [ ] LGPD/GDPR compliance review

### Documentation
- [ ] API documentation updated
- [ ] User guide for preferences
- [ ] Admin guide for preference management
- [ ] Compliance documentation

---

**Created**: 2025-01-27  
**Priority**: MEDIUM  
**Estimated Effort**: 3 Story Points  
**Target Sprint**: Sprint 2 or 3  
**Dependencies**: Story 4.1 (Email Infrastructure)