# Story 4.4 - Email Analytics & Monitoring

## Status

📋 **READY FOR PLANNING**

**Epic**: [Epic 7 - Email Management System](./epic-7-email-management.md)  
**Priority**: LOW  
**Story Points**: 3  
**Sprint**: 3  
**Dependencies**: [Story 4.1](./4.1.email-infrastructure.md), [Story 4.2](./4.2.maintenance-reminders.md)

## 📊 Story Overview

**Como** administrador do sistema  
**Eu quero** visualizar analytics e monitoramento dos emails enviados  
**Para que** eu possa acompanhar a performance do sistema de emails e identificar problemas

## 🎯 Business Value

- **Operational Excellence**: Visibilidade sobre saúde do sistema de emails
- **Performance Optimization**: Identificar gargalos e oportunidades de melhoria
- **Business Insights**: Entender engagement dos usuários com emails
- **Compliance**: Audit trail para emails enviados

## 📋 Acceptance Criteria

### AC1: Email Analytics Dashboard
- [ ] Dashboard page (`/admin/email-analytics`) para administradores
- [ ] Métricas resumidas (emails enviados, delivery rate, open rate)
- [ ] Gráficos de evolução temporal (últimos 30 dias)
- [ ] Breakdown por tipo de email (password reset, maintenance reminder)
- [ ] Performance metrics (tempo de processamento, falhas)

### AC2: Email Tracking Integration
- [ ] Integration com Resend webhooks para tracking events
- [ ] Webhook endpoint para receber delivery/open/click events
- [ ] Database storage para email events
- [ ] Correlation entre emails enviados e events recebidos
- [ ] Real-time updating de status dos emails

### AC3: Error Monitoring & Alerting
- [ ] Detection de falhas consecutivas de email
- [ ] Email alert para administradores quando error rate > 5%
- [ ] Logging detalhado de erros de email
- [ ] Dashboard de health check para sistema de emails
- [ ] Retry tracking e success rate monitoring

### AC4: Analytics API
- [ ] GET `/api/admin/email-analytics/summary` endpoint
- [ ] GET `/api/admin/email-analytics/events` endpoint com filtros
- [ ] GET `/api/admin/email-analytics/performance` endpoint
- [ ] Authentication e authorization para admin only
- [ ] Rate limiting e caching para performance

### AC5: Reporting & Export
- [ ] Weekly automated email reports para administradores
- [ ] CSV export de email logs para auditoria
- [ ] Filtros por date range, email type, status
- [ ] Scheduled reports configuration
- [ ] Data retention policy (90 dias)

## 🔧 Technical Implementation

### Database Schema Extensions
```sql
-- Enhanced email_logs with tracking events
ALTER TABLE email_logs ADD COLUMN IF NOT EXISTS 
  delivered_at TIMESTAMPTZ,
  opened_at TIMESTAMPTZ,
  clicked_at TIMESTAMPTZ,
  bounced_at TIMESTAMPTZ,
  complained_at TIMESTAMPTZ,
  webhook_id VARCHAR(255),
  tracking_data JSONB;

-- Email analytics summary table (for performance)
CREATE TABLE email_analytics_daily (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  date DATE NOT NULL,
  email_type VARCHAR(50) NOT NULL,
  total_sent INTEGER DEFAULT 0,
  total_delivered INTEGER DEFAULT 0,
  total_opened INTEGER DEFAULT 0,
  total_clicked INTEGER DEFAULT 0,
  total_bounced INTEGER DEFAULT 0,
  total_complained INTEGER DEFAULT 0,
  avg_processing_time_ms INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(date, email_type)
);

CREATE INDEX idx_email_analytics_daily_date ON email_analytics_daily(date);
CREATE INDEX idx_email_analytics_daily_email_type ON email_analytics_daily(email_type);

-- Email alerts configuration
CREATE TABLE email_alert_configs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  alert_type VARCHAR(50) NOT NULL,
  threshold_value DECIMAL NOT NULL,
  threshold_type VARCHAR(20) NOT NULL, -- 'percentage', 'count', 'time'
  is_enabled BOOLEAN DEFAULT true,
  recipients TEXT[] NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Webhook Handler for Resend Events
```typescript
// backend/src/controllers/emailWebhookController.ts
export class EmailWebhookController {
  async handleResendWebhook(req: Request, res: Response): Promise<void> {
    try {
      const signature = req.headers['resend-signature'] as string;
      const payload = req.body;

      // Verify webhook signature
      if (!this.verifyWebhookSignature(signature, payload)) {
        return res.status(401).json({ error: 'Invalid signature' });
      }

      await this.processWebhookEvent(payload);
      res.status(200).json({ success: true });
    } catch (error) {
      console.error('Webhook processing error:', error);
      res.status(500).json({ error: 'Internal server error' });
    }
  }

  private async processWebhookEvent(event: ResendWebhookEvent): Promise<void> {
    const { type, data } = event;

    await prisma.emailLogs.updateMany({
      where: { resend_id: data.email_id },
      data: {
        [`${type}_at`]: new Date(data.created_at),
        tracking_data: data,
      },
    });

    // Update daily analytics
    await this.updateDailyAnalytics(type, data);

    // Check for alerts
    await this.checkAlertConditions();
  }

  private async updateDailyAnalytics(eventType: string, data: any): Promise<void> {
    const today = new Date().toISOString().split('T')[0];
    const emailType = data.email_type || 'unknown';

    await prisma.emailAnalyticsDaily.upsert({
      where: {
        date_email_type: {
          date: today,
          email_type: emailType,
        },
      },
      update: {
        [`total_${eventType}`]: {
          increment: 1,
        },
      },
      create: {
        date: today,
        email_type: emailType,
        [`total_${eventType}`]: 1,
      },
    });
  }
}
```

### Analytics Service
```typescript
// backend/src/services/emailAnalyticsService.ts
export class EmailAnalyticsService {
  async getSummaryAnalytics(days: number = 30): Promise<EmailAnalyticsSummary> {
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - days);

    const summary = await prisma.emailAnalyticsDaily.aggregate({
      where: {
        date: {
          gte: startDate,
        },
      },
      _sum: {
        total_sent: true,
        total_delivered: true,
        total_opened: true,
        total_clicked: true,
        total_bounced: true,
        total_complained: true,
      },
    });

    const deliveryRate = summary._sum.total_sent > 0 
      ? (summary._sum.total_delivered / summary._sum.total_sent) * 100 
      : 0;

    const openRate = summary._sum.total_delivered > 0 
      ? (summary._sum.total_opened / summary._sum.total_delivered) * 100 
      : 0;

    return {
      totalSent: summary._sum.total_sent || 0,
      totalDelivered: summary._sum.total_delivered || 0,
      totalOpened: summary._sum.total_opened || 0,
      deliveryRate: Math.round(deliveryRate * 100) / 100,
      openRate: Math.round(openRate * 100) / 100,
      bounceRate: Math.round(((summary._sum.total_bounced || 0) / (summary._sum.total_sent || 1)) * 10000) / 100,
    };
  }

  async getPerformanceMetrics(): Promise<EmailPerformanceMetrics> {
    const recentLogs = await prisma.emailLogs.findMany({
      where: {
        created_at: {
          gte: new Date(Date.now() - 24 * 60 * 60 * 1000), // Last 24 hours
        },
      },
      select: {
        created_at: true,
        sent_at: true,
        status: true,
      },
    });

    const processingTimes = recentLogs
      .filter(log => log.sent_at)
      .map(log => log.sent_at.getTime() - log.created_at.getTime());

    const avgProcessingTime = processingTimes.length > 0 
      ? processingTimes.reduce((a, b) => a + b, 0) / processingTimes.length 
      : 0;

    const successRate = recentLogs.length > 0 
      ? (recentLogs.filter(log => log.status === 'sent').length / recentLogs.length) * 100 
      : 0;

    return {
      avgProcessingTimeMs: Math.round(avgProcessingTime),
      successRate: Math.round(successRate * 100) / 100,
      totalProcessed: recentLogs.length,
      queueHealth: 'healthy', // TODO: Implement queue health check
    };
  }
}
```

### Analytics Dashboard Component
```typescript
// frontend/src/components/admin/EmailAnalyticsDashboard.tsx
import { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';

interface EmailAnalytics {
  summary: EmailAnalyticsSummary;
  performance: EmailPerformanceMetrics;
  dailyData: DailyEmailData[];
}

export default function EmailAnalyticsDashboard() {
  const [analytics, setAnalytics] = useState<EmailAnalytics | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [timeRange, setTimeRange] = useState(30);

  useEffect(() => {
    loadAnalytics();
  }, [timeRange]);

  const loadAnalytics = async () => {
    setIsLoading(true);
    try {
      const [summaryRes, performanceRes] = await Promise.all([
        fetch(`/api/admin/email-analytics/summary?days=${timeRange}`),
        fetch('/api/admin/email-analytics/performance'),
      ]);

      const summary = await summaryRes.json();
      const performance = await performanceRes.json();

      setAnalytics({
        summary: summary.data,
        performance: performance.data,
        dailyData: [], // TODO: Load daily data
      });
    } catch (error) {
      console.error('Failed to load analytics:', error);
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return <div className="p-6">Loading analytics...</div>;
  }

  return (
    <div className="p-6 max-w-7xl mx-auto">
      <div className="mb-6">
        <h1 className="text-3xl font-bold text-gray-900">Email Analytics</h1>
        <div className="mt-2">
          <select
            value={timeRange}
            onChange={(e) => setTimeRange(Number(e.target.value))}
            className="border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"
          >
            <option value={7}>Last 7 days</option>
            <option value={30}>Last 30 days</option>
            <option value={90}>Last 90 days</option>
          </select>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div className="bg-white overflow-hidden shadow rounded-lg">
          <div className="p-5">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <div className="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                  <span className="text-white font-bold">📧</span>
                </div>
              </div>
              <div className="ml-5 w-0 flex-1">
                <dl>
                  <dt className="text-sm font-medium text-gray-500 truncate">Total Sent</dt>
                  <dd className="text-lg font-medium text-gray-900">
                    {analytics?.summary.totalSent.toLocaleString()}
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </div>

        <div className="bg-white overflow-hidden shadow rounded-lg">
          <div className="p-5">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <div className="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                  <span className="text-white font-bold">✅</span>
                </div>
              </div>
              <div className="ml-5 w-0 flex-1">
                <dl>
                  <dt className="text-sm font-medium text-gray-500 truncate">Delivery Rate</dt>
                  <dd className="text-lg font-medium text-gray-900">
                    {analytics?.summary.deliveryRate}%
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </div>

        <div className="bg-white overflow-hidden shadow rounded-lg">
          <div className="p-5">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <div className="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                  <span className="text-white font-bold">👁️</span>
                </div>
              </div>
              <div className="ml-5 w-0 flex-1">
                <dl>
                  <dt className="text-sm font-medium text-gray-500 truncate">Open Rate</dt>
                  <dd className="text-lg font-medium text-gray-900">
                    {analytics?.summary.openRate}%
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </div>

        <div className="bg-white overflow-hidden shadow rounded-lg">
          <div className="p-5">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <div className="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                  <span className="text-white font-bold">⚡</span>
                </div>
              </div>
              <div className="ml-5 w-0 flex-1">
                <dl>
                  <dt className="text-sm font-medium text-gray-500 truncate">Avg Processing</dt>
                  <dd className="text-lg font-medium text-gray-900">
                    {analytics?.performance.avgProcessingTimeMs}ms
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div className="bg-white p-6 rounded-lg shadow">
          <h3 className="text-lg font-medium text-gray-900 mb-4">Email Volume Over Time</h3>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={analytics?.dailyData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="date" />
              <YAxis />
              <Tooltip />
              <Line type="monotone" dataKey="sent" stroke="#3B82F6" strokeWidth={2} />
              <Line type="monotone" dataKey="delivered" stroke="#10B981" strokeWidth={2} />
            </LineChart>
          </ResponsiveContainer>
        </div>

        <div className="bg-white p-6 rounded-lg shadow">
          <h3 className="text-lg font-medium text-gray-900 mb-4">Performance Metrics</h3>
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <span className="text-sm text-gray-600">Success Rate</span>
              <span className="text-lg font-medium text-green-600">
                {analytics?.performance.successRate}%
              </span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-sm text-gray-600">Queue Health</span>
              <span className="text-lg font-medium text-green-600">
                {analytics?.performance.queueHealth}
              </span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-sm text-gray-600">Total Processed (24h)</span>
              <span className="text-lg font-medium text-gray-900">
                {analytics?.performance.totalProcessed}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
```

## 🧪 Testing Strategy

### Unit Tests
- [ ] EmailAnalyticsService methods
- [ ] Webhook signature verification
- [ ] Daily analytics aggregation
- [ ] Alert condition checking

### Integration Tests
- [ ] Webhook event processing
- [ ] Analytics API endpoints
- [ ] Database analytics queries
- [ ] Email alert sending

### E2E Tests
- [ ] Dashboard loads with correct data
- [ ] Webhook events update analytics
- [ ] Alert emails are sent when thresholds exceeded
- [ ] Export functionality works

## 📊 Success Metrics

### Technical KPIs
- [ ] < 100ms analytics API response time
- [ ] 99.9% webhook processing reliability
- [ ] Real-time dashboard updates
- [ ] Zero data loss in analytics

### Business KPIs
- [ ] Proactive issue detection (< 5 min alert time)
- [ ] Improved email performance through insights
- [ ] 100% compliance with audit requirements
- [ ] Reduced operational overhead

## ⚙️ Environment Variables

```bash
# Analytics Configuration
EMAIL_ANALYTICS_RETENTION_DAYS=90
EMAIL_ANALYTICS_ALERT_RECIPIENTS=admin@example.com,ops@example.com

# Webhook Configuration
RESEND_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxxxxx
WEBHOOK_SIGNATURE_TOLERANCE=300

# Alert Thresholds
EMAIL_ERROR_RATE_THRESHOLD=5
EMAIL_BOUNCE_RATE_THRESHOLD=10
```

## 🔍 Risk Assessment

### Technical Risks
- **Low**: Webhook reliability
- **Low**: Analytics query performance
- **Medium**: Data volume growth

### Mitigation
- Webhook retry mechanism
- Database indexing and optimization
- Data retention policies
- Query caching for dashboard

## 📋 Definition of Done

### Functional Requirements
- [ ] All Acceptance Criteria completed
- [ ] Analytics dashboard functional
- [ ] Webhook integration working
- [ ] Alert system operational
- [ ] Export functionality available

### Quality Assurance
- [ ] 95%+ test coverage
- [ ] Performance testing with large datasets
- [ ] Security review of webhook endpoints
- [ ] Dashboard accessibility testing

### Documentation
- [ ] Analytics dashboard user guide
- [ ] Webhook setup documentation
- [ ] Alert configuration guide
- [ ] Troubleshooting procedures

---

**Created**: 2025-01-27  
**Priority**: LOW  
**Estimated Effort**: 3 Story Points  
**Target Sprint**: Sprint 3  
**Dependencies**: Stories 4.1, 4.2 (Email Infrastructure + Reminders)