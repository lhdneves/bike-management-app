# Story 4.1 - Email Infrastructure & Password Reset

## Status

🎯 \*_DONE_

**Epic**: [Epic 7 - Email Management System](./epic-7-email-management.md)  
**Priority**: CRITICAL  
**Story Points**: 5  
**Sprint**: 1  
**Dependencies**: None

## 📧 Story Overview

**Como** usuário do sistema  
**Eu quero** poder resetar minha senha via email  
**Para que** eu possa recuperar acesso à minha conta de forma segura e independente

## 🎯 Business Value

- **Critical Pain Point**: Password reset é a funcionalidade mais solicitada no suporte
- **User Experience**: Permite recuperação independente de acesso
- **Support Reduction**: Reduz drasticamente tickets relacionados a senha
- **Foundation**: Estabelece infraestrutura para futuras funcionalidades de email

## 📋 Acceptance Criteria

### AC1: Resend Integration Setup

- [ ] Conta Resend configurada e domínio verificado
- [ ] Environment variables configuradas (API key, from email, etc.)
- [ ] EmailService base class implementada
- [ ] Connection testing e error handling básico

### AC2: Password Reset Backend

- [ ] Endpoint POST `/api/auth/forgot-password` implementado
- [ ] Endpoint POST `/api/auth/reset-password` implementado
- [ ] Token generation seguro (crypto random + expiry)
- [ ] Database migration para `password_reset_tokens` table
- [ ] Rate limiting (max 3 tentativas por hora por email)

### AC3: Password Reset Frontend

- [ ] Página "Esqueci minha senha" (`/forgot-password`)
- [ ] Página "Reset de senha" (`/reset-password?token=xxx`)
- [ ] Form validation e error handling
- [ ] Success/error messaging apropriado
- [ ] Link na página de login para "Esqueci minha senha"

### AC4: Email Template

- [ ] PasswordReset React email template implementado
- [ ] Template responsivo e profissional
- [ ] Branding consistente com a aplicação
- [ ] Link de reset com expiração clara (1 hora)
- [ ] Fallback text version do email

### AC5: Security & Validation

- [ ] Tokens únicos e criptograficamente seguros
- [ ] Expiração automática após 1 hora
- [ ] Invalidação após uso
- [ ] Validação de email format
- [ ] CSRF protection nos forms

## 🔧 Technical Implementation

### Dependencies Required

```json
{
  "resend": "^2.0.0",
  "@react-email/components": "^0.0.12",
  "@react-email/render": "^0.0.10",
  "crypto": "built-in"
}
```

### Database Schema

```sql
CREATE TABLE password_reset_tokens (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  token VARCHAR(255) UNIQUE NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  used_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_password_reset_tokens_token ON password_reset_tokens(token);
CREATE INDEX idx_password_reset_tokens_user_id ON password_reset_tokens(user_id);
CREATE INDEX idx_password_reset_tokens_expires_at ON password_reset_tokens(expires_at);
```

### API Endpoints

#### POST /api/auth/forgot-password

```typescript
interface ForgotPasswordRequest {
  email: string;
}

interface ForgotPasswordResponse {
  success: boolean;
  message: string;
}
```

#### POST /api/auth/reset-password

```typescript
interface ResetPasswordRequest {
  token: string;
  newPassword: string;
}

interface ResetPasswordResponse {
  success: boolean;
  message: string;
  errors?: ValidationError[];
}
```

### Email Service Architecture

```typescript
// backend/src/services/emailService.ts
export class EmailService {
  private resend: Resend;

  constructor() {
    this.resend = new Resend(process.env.RESEND_API_KEY);
  }

  async sendPasswordReset(
    email: string,
    resetToken: string
  ): Promise<EmailResult> {
    const resetUrl = `${process.env.FRONTEND_URL}/reset-password?token=${resetToken}`;

    const { data, error } = await this.resend.emails.send({
      from: process.env.RESEND_FROM_EMAIL,
      to: email,
      subject: "Reset Your Password",
      react: PasswordResetEmail({
        resetUrl,
        expiresIn: "1 hour",
      }),
    });

    return { success: !error, data, error };
  }
}
```

## 📧 Email Template

### Password Reset Template

```tsx
// backend/src/emails/PasswordReset.tsx
import {
  Html,
  Head,
  Body,
  Container,
  Section,
  Text,
  Button,
  Heading,
} from "@react-email/components";

interface PasswordResetEmailProps {
  resetUrl: string;
  expiresIn: string;
}

export const PasswordResetEmail = ({
  resetUrl,
  expiresIn,
}: PasswordResetEmailProps) => (
  <Html>
    <Head />
    <Body style={main}>
      <Container style={container}>
        <Section style={box}>
          <Heading style={h1}>🔐 Reset Your Password</Heading>

          <Text style={text}>
            You requested to reset your password. Click the button below to set
            a new password:
          </Text>

          <Button style={button} href={resetUrl}>
            Reset Password
          </Button>

          <Text style={text}>
            This link will expire in {expiresIn}. If you didn't request this,
            please ignore this email.
          </Text>
        </Section>
      </Container>
    </Body>
  </Html>
);

const main = { backgroundColor: "#f6f9fc", fontFamily: "Arial, sans-serif" };
const container = {
  margin: "0 auto",
  padding: "20px 0 48px",
  maxWidth: "560px",
};
const box = {
  padding: "32px",
  backgroundColor: "#ffffff",
  border: "1px solid #f0f0f0",
  borderRadius: "8px",
};
const h1 = {
  color: "#333",
  fontSize: "24px",
  fontWeight: "bold",
  margin: "0 0 24px",
  textAlign: "center" as const,
};
const text = {
  color: "#333",
  fontSize: "16px",
  lineHeight: "24px",
  margin: "0 0 16px",
};
const button = {
  backgroundColor: "#007bff",
  borderRadius: "6px",
  color: "#ffffff",
  fontSize: "16px",
  fontWeight: "bold",
  textDecoration: "none",
  textAlign: "center" as const,
  display: "block",
  padding: "12px 24px",
  margin: "24px 0",
};
```

## 🧪 Testing Strategy

### Unit Tests

- [ ] EmailService.sendPasswordReset()
- [ ] Token generation and validation
- [ ] Password reset endpoints
- [ ] Email template rendering

### Integration Tests

- [ ] Complete password reset flow
- [ ] Token expiration handling
- [ ] Rate limiting validation
- [ ] Database operations

### E2E Tests

- [ ] User requests password reset
- [ ] Email is received and link works
- [ ] Password is successfully changed
- [ ] User can login with new password

## 📊 Success Metrics

### Technical KPIs

- [ ] 99%+ email delivery rate
- [ ] < 2s email sending time
- [ ] 90%+ password reset completion rate
- [ ] Zero security incidents

### Business KPIs

- [ ] 50%+ reduction in password-related support tickets
- [ ] < 5 minutes average time to reset password
- [ ] 95%+ user satisfaction with reset process

## ⚙️ Environment Variables

```bash
# Resend Configuration
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxx
RESEND_FROM_EMAIL=noreply@yourdomain.com
RESEND_FROM_NAME="Bicycle Maintenance"

# Frontend URLs
FRONTEND_URL=http://localhost:3000

# Password Reset Settings
PASSWORD_RESET_TOKEN_EXPIRY=3600
PASSWORD_RESET_RATE_LIMIT=3
```

## 🔍 Risk Assessment

### Technical Risks

- **Low**: Resend API reliability
- **Low**: Email deliverability issues
- **Medium**: Token security implementation

### Mitigation

- Comprehensive error handling for email failures
- Proper token generation using crypto module
- Rate limiting to prevent abuse
- Thorough security testing

## 📋 Definition of Done

### Functional Requirements

- [ ] All Acceptance Criteria completed
- [ ] Password reset flow working end-to-end
- [ ] Email template professional and responsive
- [ ] Security measures properly implemented
- [ ] Error handling and user feedback working

### Quality Assurance

- [ ] 95%+ test coverage
- [ ] Security review completed
- [ ] Performance testing passed
- [ ] Cross-browser compatibility verified
- [ ] Email client testing completed

### Documentation

- [ ] API documentation updated
- [ ] Setup instructions documented
- [ ] Security considerations documented
- [ ] Troubleshooting guide created

---

**Created**: 2025-01-27  
**Priority**: CRITICAL  
**Estimated Effort**: 5 Story Points  
**Target Sprint**: Sprint 1  
**Dependencies**: None
