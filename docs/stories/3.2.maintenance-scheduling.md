# Story 3.2: Maintenance Scheduling

## Status

Done

## Story

**As a** bicycle owner,
**I want** to schedule future maintenance activities with specific dates and service descriptions,
**so that** I can plan ahead and receive reminders for upcoming maintenance needs.

## Acceptance Criteria

1. User can access maintenance scheduling from bike details page
2. User can schedule future maintenance with date and service description
3. Scheduled date must be in the future (validation required)
4. Service description is mandatory for scheduled maintenance
5. User can optionally set notification days before scheduled date
6. User can save or cancel scheduled maintenance entry
7. Scheduled maintenance records are stored and linked to specific bikes
8. User can view list of scheduled maintenance for each bike
9. User can edit or delete scheduled maintenance entries
10. System displays scheduled maintenance in chronological order (upcoming first)

## Tasks / Subtasks

- [ ] Task 1: Complete backend API for scheduled maintenance CRUD operations (AC: 2, 6, 7, 9)
  - [ ] Add POST endpoint for creating scheduled maintenance
  - [ ] Add PUT endpoint for updating scheduled maintenance
  - [ ] Add DELETE endpoint for removing scheduled maintenance
  - [ ] Implement validation for future date requirements
  - [ ] Add notification_days_before field support
  - [ ] Ensure proper bike ownership verification for all operations

- [ ] Task 2: Extend maintenance API utility for scheduled maintenance (AC: 2, 7, 8, 9)
  - [ ] Add ScheduledMaintenance interface to maintenanceApi.ts
  - [ ] Add CreateScheduledMaintenanceData interface
  - [ ] Add UpdateScheduledMaintenanceData interface
  - [ ] Implement API methods for scheduled maintenance CRUD operations
  - [ ] Add method to get scheduled maintenance for specific bike

- [ ] Task 3: Create scheduled maintenance frontend components (AC: 1, 2, 5, 8)
  - [ ] Create ScheduledMaintenanceModal component for adding/editing scheduled maintenance
  - [ ] Create ScheduledMaintenanceList component for displaying scheduled maintenance
  - [ ] Implement form validation for future dates and required fields
  - [ ] Add notification days before dropdown/input field
  - [ ] Integrate components with bike details page

- [ ] Task 4: Update bike details page with scheduled maintenance functionality (AC: 1, 8, 10)
  - [ ] Add "Agendar Manutenção" button to bike details page
  - [ ] Add scheduled maintenance section to display upcoming maintenance
  - [ ] Implement toggle between maintenance history and scheduled maintenance views
  - [ ] Handle empty state when no scheduled maintenance exists

- [ ] Task 5: Write comprehensive tests (AC: All)
  - [ ] Unit tests for scheduled maintenance API endpoints
  - [ ] Integration tests for CRUD operations with bike ownership validation
  - [ ] Frontend component tests for scheduled maintenance forms and displays
  - [ ] End-to-end tests for complete maintenance scheduling workflow
  - [ ] Test date validation and future date requirements

## Dev Notes

### Previous Story Dependencies

This story builds upon completed story:

- Story 3.1 (Maintenance Logging) - Established maintenance patterns, components, and API structure

### Data Models

Based on the existing database schema, this story will primarily work with:

**Scheduled Maintenance Table Structure** [Source: backend/prisma/schema.prisma]:

- `id` (UUID, Primary Key) - Unique identifier for the scheduled maintenance
- `bike_id` (UUID, Foreign Key to bikes.id, Not Null) - Links scheduled maintenance to specific bike
- `scheduled_date` (DATE, Not Null) - Date the maintenance is scheduled for
- `service_description` (TEXT, Not Null) - Description of the service planned
- `notification_days_before` (INTEGER, Optional) - Number of days before scheduled_date to send reminder
- `is_completed` (BOOLEAN, Not Null, Default: FALSE) - Flag to mark if scheduled maintenance has been completed
- `created_at` (TIMESTAMP, Not Null, Default: CURRENT_TIMESTAMP)
- `updated_at` (TIMESTAMP, Not Null, Default: CURRENT_TIMESTAMP, On Update: CURRENT_TIMESTAMP)

**Existing Bikes Table** [Source: backend/prisma/schema.prisma]:

- Already established from Story 1.2
- Foreign key relationship: scheduled_maintenance.bike_id → bikes.id

### API Specifications

**Required API Endpoints** [Source: backend/src/routes/maintenance.ts - existing patterns]:

- GET /api/maintenance/scheduled - List all scheduled maintenance for user (existing, basic implementation)
- GET /api/bikes/:id/scheduled-maintenance - List scheduled maintenance for specific bike (to be added)
- POST /api/bikes/:id/scheduled-maintenance - Create new scheduled maintenance for bike (to be added)
- GET /api/scheduled-maintenance/:id - Get specific scheduled maintenance details (to be added)
- PUT /api/scheduled-maintenance/:id - Update scheduled maintenance (to be added)
- DELETE /api/scheduled-maintenance/:id - Delete scheduled maintenance (to be added)

**Request/Response Formats** [Source: existing maintenance API patterns]:

- POST /api/bikes/:id/scheduled-maintenance payload: { scheduled_date, service_description, notification_days_before? }
- GET responses include full scheduled maintenance data with bike ownership validation
- All endpoints follow existing authentication and authorization patterns from Story 3.1

### Component Specifications

**Frontend Components** [Source: existing maintenance components patterns]:

- **ScheduledMaintenanceModal**: Modal for creating/editing scheduled maintenance (similar to MaintenanceModal)
- **ScheduledMaintenanceList**: Component showing scheduled maintenance records (similar to MaintenanceHistory)
- **ScheduledMaintenanceCard**: Individual scheduled maintenance record display
- **BikeDetails**: Extended to include scheduled maintenance access point and display

### File Locations

Based on existing project structure [Source: current codebase]:

**Backend Files**:

- backend/src/routes/maintenance.ts - Extend existing routes with scheduled maintenance endpoints
- backend/tests/scheduled-maintenance.test.ts - New test file for scheduled maintenance

**Frontend Files**:

- frontend/src/utils/maintenanceApi.ts - Extend existing utility with scheduled maintenance methods
- frontend/src/components/maintenance/ScheduledMaintenanceModal.tsx - New component
- frontend/src/components/maintenance/ScheduledMaintenanceList.tsx - New component
- frontend/src/components/maintenance/**tests**/ScheduledMaintenanceModal.test.tsx - New test file
- frontend/src/components/maintenance/**tests**/ScheduledMaintenanceList.test.tsx - New test file
- frontend/src/app/bikes/[id]/page.tsx - Update existing page with scheduled maintenance integration

### UI/UX Considerations

**Based on UI/UX Specifications** [Source: docs/ui-ux-spec.md]:

- **Modal Interface**: Scheduled maintenance entry via modal from bike details page (following existing maintenance patterns)
- **Form Fields**: Future Date (mandatory), Service Description (mandatory), Notification Days (optional)
- **Validation**: Future date validation, clear error messages for past dates
- **Save/Cancel Actions**: Standard form controls consistent with existing maintenance modal
- **Mobile Responsive**: Forms optimized for smartphone usage (following existing patterns)

### Technical Constraints

**Security Requirements** [Source: existing maintenance implementation]:

- Scheduled maintenance records must verify bike ownership before any operations
- JWT authentication required for all scheduled maintenance endpoints
- Input validation on both client and server side
- Proper error handling for unauthorized access

**Validation Requirements**:

- Scheduled date must be in the future (cannot schedule maintenance for past dates)
- Service description is mandatory
- Notification days before must be positive integer if provided
- All existing maintenance validation patterns apply

**Performance Considerations** [Source: existing maintenance implementation]:

- Efficient queries for scheduled maintenance retrieval
- Proper indexing on scheduled_date for performance
- Optimistic UI updates for better user experience
- Date picker optimization for mobile devices

**Integration Points** [Source: docs/architecture.md]:

- Express.js backend with Prisma ORM for database operations
- Next.js frontend with TypeScript and Tailwind CSS
- Supabase PostgreSQL database for data persistence
- Follows existing authentication middleware patterns

### Testing Requirements

**Comprehensive Testing Strategy** [Source: existing maintenance testing patterns]:

- Unit tests for scheduled maintenance CRUD operations and validation
- Integration tests for API endpoints with proper authorization
- Component tests for React forms and scheduled maintenance display
- End-to-end tests for complete maintenance scheduling workflow
- Security tests for bike ownership verification
- Date validation tests for future date requirements

## Story Dependencies

- **Requires**: Story 3.1 (Maintenance Logging) - COMPLETED
- **Blocks**: Story 3.3 (Maintenance Reports) - depends on both logged and scheduled maintenance data
- **Blocks**: Story 3.4 (Email Notifications) - depends on scheduled maintenance data structure

## Estimated Effort

**Complexity**: Medium
**Estimated Duration**: 2-3 days
**Story Points**: 5

## Change Log

| Date | Version | Description | Author |1
