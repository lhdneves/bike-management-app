# Story 4.2 - Maintenance Reminder System

## Status

üöß **IN PROGRESS - SPRINT 2**

**Epic**: [Epic 7 - Email Management System](./epic-7-email-management.md)  
**Priority**: HIGH  
**Story Points**: 5  
**Sprint**: 2  
**Dependencies**: [Story 4.1](./4.1.email-infrastructure.md) (Email Infrastructure)

## üìÖ Story Overview

**Como** usu√°rio com manuten√ß√µes agendadas  
**Eu quero** receber lembretes autom√°ticos por email  
**Para que** eu n√£o esque√ßa de realizar as manuten√ß√µes programadas das minhas bicicletas

## üéØ Business Value

- **User Engagement**: Aumenta participa√ß√£o ativa em 35%
- **Maintenance Completion**: Melhora taxa de conclus√£o de manuten√ß√µes
- **User Retention**: Mant√©m usu√°rios engajados com a plataforma
- **Habit Formation**: Cria rotina de cuidado com bicicletas

## üìã Acceptance Criteria

### AC1: Background Job System
- [ ] Redis setup para queue management
- [ ] Bull queue implementado para email jobs
- [ ] Job retry logic com exponential backoff
- [ ] Dead letter queue para jobs com falha persistente
- [ ] Queue monitoring e health checks

### AC2: Maintenance Scanning Logic
- [ ] Cron job di√°rio para scan de agendamentos
- [ ] L√≥gica para calcular quando enviar lembretes baseado em `notificationDaysBefore`
- [ ] Preven√ß√£o de lembretes duplicados
- [ ] Filtro para usu√°rios que n√£o optaram por receber lembretes
- [ ] Handling de timezone do usu√°rio

### AC3: Maintenance Reminder Email
- [ ] Template React para lembrete de manuten√ß√£o
- [ ] Personaliza√ß√£o com dados da bicicleta e manuten√ß√£o
- [ ] Link direto para p√°gina da bicicleta
- [ ] Informa√ß√µes de urg√™ncia (quantos dias restam)
- [ ] Unsubscribe link funcional

### AC4: User Preferences Integration
- [ ] Check de prefer√™ncias antes de enviar emails
- [ ] Respeitar configura√ß√µes de frequency
- [ ] Handling de usu√°rios unsubscribed
- [ ] Log de emails enviados para auditoria

### AC5: Monitoring & Error Handling
- [ ] Logs detalhados de processamento de jobs
- [ ] Error handling para falhas de envio
- [ ] Metrics de jobs processados vs falhados
- [ ] Alertas para falhas consecutivas

## üîß Technical Implementation

### Dependencies Required
```json
{
  "bull": "^4.12.0",
  "ioredis": "^5.3.0",
  "node-cron": "^3.0.3"
}
```

### Database Schema Extensions
```sql
-- Extend user_email_preferences if not exists
CREATE TABLE IF NOT EXISTS user_email_preferences (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) UNIQUE,
  maintenance_reminders BOOLEAN DEFAULT true,
  reminder_frequency VARCHAR(20) DEFAULT 'once', -- 'once', 'daily', 'disabled'
  unsubscribed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Email logs for tracking sent reminders
CREATE TABLE email_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  scheduled_maintenance_id UUID REFERENCES scheduled_maintenance(id),
  email_type VARCHAR(50) NOT NULL,
  recipient_email VARCHAR(255) NOT NULL,
  resend_id VARCHAR(255),
  status VARCHAR(20) DEFAULT 'pending',
  sent_at TIMESTAMPTZ,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_email_logs_user_id ON email_logs(user_id);
CREATE INDEX idx_email_logs_scheduled_maintenance_id ON email_logs(scheduled_maintenance_id);
CREATE INDEX idx_email_logs_email_type ON email_logs(email_type);
```

### Background Job Architecture
```typescript
// backend/src/jobs/emailQueue.ts
import Bull from 'bull';

export class EmailQueue {
  private queue: Bull.Queue;

  constructor() {
    this.queue = new Bull('email processing', process.env.REDIS_URL);
    this.setupJobProcessor();
  }

  async addMaintenanceReminderJob(reminderData: MaintenanceReminderData, delay?: number): Promise<void> {
    await this.queue.add('maintenance-reminder', reminderData, {
      delay,
      attempts: 3,
      backoff: {
        type: 'exponential',
        delay: 2000,
      },
    });
  }

  private setupJobProcessor(): void {
    this.queue.process('maintenance-reminder', this.processMaintenanceReminder.bind(this));
  }

  private async processMaintenanceReminder(job: Bull.Job): Promise<void> {
    const { userId, scheduledMaintenanceId, bikeName, serviceDescription, scheduledDate } = job.data;
    
    // Check user preferences
    const preferences = await this.getUserEmailPreferences(userId);
    if (!preferences?.maintenance_reminders) {
      return; // User opted out
    }

    // Send reminder email
    await emailService.sendMaintenanceReminder({
      userId,
      scheduledMaintenanceId,
      bikeName,
      serviceDescription,
      scheduledDate,
    });
  }
}
```

### Cron Job for Scanning
```typescript
// backend/src/jobs/maintenanceReminderCron.ts
import cron from 'node-cron';

export class MaintenanceReminderCron {
  start(): void {
    // Run daily at 9:00 AM
    cron.schedule('0 9 * * *', this.scanAndScheduleReminders.bind(this));
  }

  private async scanAndScheduleReminders(): Promise<void> {
    console.log('üîç Scanning for maintenance reminders...');

    const scheduledMaintenances = await prisma.scheduledMaintenance.findMany({
      where: {
        isCompleted: false,
        scheduledDate: {
          gte: new Date(), // Only future maintenance
        },
      },
      include: {
        bike: {
          include: {
            owner: true,
          },
        },
      },
    });

    for (const maintenance of scheduledMaintenances) {
      await this.scheduleReminderIfNeeded(maintenance);
    }

    console.log(`‚úÖ Processed ${scheduledMaintenances.length} scheduled maintenances`);
  }

  private async scheduleReminderIfNeeded(maintenance: ScheduledMaintenanceWithBike): Promise<void> {
    const { notificationDaysBefore, scheduledDate, bike } = maintenance;
    
    if (!notificationDaysBefore) return; // No reminder requested

    const reminderDate = new Date(scheduledDate);
    reminderDate.setDate(reminderDate.getDate() - notificationDaysBefore);

    const now = new Date();
    const timeDiff = reminderDate.getTime() - now.getTime();

    // If reminder date is today or in the past, send immediately
    if (timeDiff <= 0) {
      await emailQueue.addMaintenanceReminderJob({
        userId: bike.ownerId,
        scheduledMaintenanceId: maintenance.id,
        bikeName: bike.name,
        serviceDescription: maintenance.serviceDescription,
        scheduledDate: scheduledDate.toISOString(),
        daysUntil: Math.ceil((new Date(scheduledDate).getTime() - now.getTime()) / (1000 * 60 * 60 * 24)),
      });
    } else {
      // Schedule for future
      await emailQueue.addMaintenanceReminderJob({
        userId: bike.ownerId,
        scheduledMaintenanceId: maintenance.id,
        bikeName: bike.name,
        serviceDescription: maintenance.serviceDescription,
        scheduledDate: scheduledDate.toISOString(),
        daysUntil: notificationDaysBefore,
      }, timeDiff);
    }
  }
}
```

## üìß Email Template

### Maintenance Reminder Template
```tsx
// backend/src/emails/MaintenanceReminder.tsx
import { Html, Head, Body, Container, Section, Text, Button, Heading, Hr, Link } from '@react-email/components';

interface MaintenanceReminderProps {
  userName: string;
  bikeName: string;
  serviceDescription: string;
  scheduledDate: string;
  daysUntil: number;
  bikeUrl: string;
  unsubscribeUrl: string;
}

export const MaintenanceReminderEmail = ({
  userName,
  bikeName,
  serviceDescription,
  scheduledDate,
  daysUntil,
  bikeUrl,
  unsubscribeUrl
}: MaintenanceReminderProps) => (
  <Html>
    <Head />
    <Body style={main}>
      <Container style={container}>
        <Section style={box}>
          <Heading style={h1}>üö¥‚Äç‚ôÇÔ∏è Maintenance Reminder</Heading>
          
          <Text style={text}>Hi {userName},</Text>
          
          <Text style={text}>
            Your bike <strong>{bikeName}</strong> has a scheduled maintenance 
            {daysUntil === 0 ? ' today' : ` in ${daysUntil} day${daysUntil > 1 ? 's' : ''}`}:
          </Text>
          
          <Section style={serviceBox}>
            <Heading style={serviceTitle}>üìÖ {serviceDescription}</Heading>
            <Text style={serviceText}>
              <strong>Date:</strong> {new Date(scheduledDate).toLocaleDateString()}<br />
              <strong>Bike:</strong> {bikeName}
            </Text>
          </Section>
          
          <Button style={button} href={bikeUrl}>
            View Bike Details
          </Button>
          
          <Text style={text}>
            Don't forget to perform the scheduled maintenance to keep your bike in optimal condition!
          </Text>
          
          <Hr style={hr} />
          
          <Text style={footer}>
            You're receiving this because you have maintenance reminders enabled.<br />
            <Link href={unsubscribeUrl}>Unsubscribe</Link> from maintenance reminders
          </Text>
        </Section>
      </Container>
    </Body>
  </Html>
);

// Styles...
const main = { backgroundColor: '#f6f9fc', fontFamily: 'Arial, sans-serif' };
const container = { margin: '0 auto', padding: '20px 0 48px', maxWidth: '560px' };
const box = { padding: '32px', backgroundColor: '#ffffff', border: '1px solid #f0f0f0', borderRadius: '8px' };
const h1 = { color: '#333', fontSize: '24px', fontWeight: 'bold', margin: '0 0 24px', textAlign: 'center' as const };
const text = { color: '#333', fontSize: '16px', lineHeight: '24px', margin: '0 0 16px' };
const serviceBox = { backgroundColor: '#f8f9fa', padding: '20px', borderRadius: '8px', margin: '24px 0', border: '1px solid #e9ecef' };
const serviceTitle = { color: '#333', fontSize: '18px', fontWeight: 'bold', margin: '0 0 12px' };
const serviceText = { color: '#495057', fontSize: '14px', lineHeight: '20px', margin: '0' };
const button = { backgroundColor: '#28a745', borderRadius: '6px', color: '#ffffff', fontSize: '16px', fontWeight: 'bold', textDecoration: 'none', textAlign: 'center' as const, display: 'block', padding: '12px 24px', margin: '24px 0' };
const hr = { border: 'none', borderTop: '1px solid #f0f0f0', margin: '32px 0' };
const footer = { color: '#8898aa', fontSize: '12px', lineHeight: '16px', textAlign: 'center' as const };
```

## üß™ Testing Strategy

### Unit Tests
- [ ] Cron job logic for scanning maintenance
- [ ] Reminder calculation based on notificationDaysBefore
- [ ] Email queue job processing
- [ ] User preference checking
- [ ] Template rendering with various data

### Integration Tests
- [ ] Complete reminder flow from scan to email
- [ ] Queue job retry mechanisms
- [ ] Database operations for logging
- [ ] Email service integration

### E2E Tests
- [ ] User schedules maintenance with reminder
- [ ] Reminder is sent at correct time
- [ ] User receives email with correct data
- [ ] Unsubscribe functionality works
- [ ] No reminder sent if user opted out

## üìä Success Metrics

### Technical KPIs
- [ ] 99%+ reminder delivery rate
- [ ] < 5 minutes processing time for daily scan
- [ ] < 1% job failure rate
- [ ] Zero duplicate reminders sent

### Business KPIs
- [ ] 35% increase in maintenance completion rate
- [ ] 25% increase in user engagement
- [ ] 90%+ user satisfaction with reminder timing
- [ ] < 2% unsubscribe rate

## ‚öôÔ∏è Environment Variables

```bash
# Redis Configuration
REDIS_URL=redis://localhost:6379

# Queue Configuration
EMAIL_QUEUE_NAME=email-processing
EMAIL_QUEUE_CONCURRENCY=5

# Cron Configuration
MAINTENANCE_REMINDER_ENABLED=true
MAINTENANCE_REMINDER_CRON=0 9 * * *

# Reminder Settings
DEFAULT_REMINDER_DAYS=7
MAX_REMINDER_DAYS=30
```

## üîç Risk Assessment

### Technical Risks
- **Medium**: Redis queue reliability
- **Low**: Cron job timing accuracy
- **Low**: Email template complexity

### Mitigation
- Persistent queue with Redis backup
- Job retry logic with exponential backoff
- Comprehensive error logging and monitoring
- Fallback to immediate sending if scheduling fails

## üìã Definition of Done

### Functional Requirements
- [ ] All Acceptance Criteria completed
- [ ] Maintenance reminders sent automatically
- [ ] User preferences respected
- [ ] Queue system working reliably
- [ ] Email templates professional and informative

### Quality Assurance
- [ ] 95%+ test coverage
- [ ] Load testing with large datasets
- [ ] Queue performance testing
- [ ] Email deliverability testing
- [ ] User preference testing

### Documentation
- [ ] Queue management documentation
- [ ] Cron job configuration guide
- [ ] Email template customization guide
- [ ] Troubleshooting common issues

---

**Created**: 2025-01-27  
**Priority**: HIGH  
**Estimated Effort**: 5 Story Points  
**Target Sprint**: Sprint 2  
**Dependencies**: Story 4.1 (Email Infrastructure)